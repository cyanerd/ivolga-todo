# Система динамической доставки для IVOLGA

## Описание

Система заменяет захардкоженные варианты доставки на динамические, которые учитывают:
- Местоположение пользователя (выбранный город)
- Настройки магазина для каждого города
- Сумму заказа (скидки на доставку)
- Вес и объем товаров
- Доступность различных методов доставки

## Файлы

### 1. AJAX обработчик
- **Файл**: `/ajax/get_delivery_options.php`
- **Функция**: Возвращает варианты доставки для выбранного города

### 2. Обновленный checkout
- **Файл**: `/checkout/index.php`
- **Изменения**: Заменены статические варианты доставки на динамические

### 3. JavaScript функциональность
- **Файл**: `/local/templates/main/js/custom.js`
- **Добавлено**: Функции для загрузки и обновления вариантов доставки

### 4. CSS стили
- **Файл**: `/local/templates/main/css/style.css`
- **Добавлено**: Стили для индикаторов загрузки и ошибок

### 5. Тестовый файл
- **Файл**: `/test_delivery.html`
- **Назначение**: Тестирование работы системы доставки

## Функциональность

### Поддерживаемые города
- Москва
- Санкт-Петербург
- Казань
- Краснодар
- Другие города (с базовыми настройками)

### Методы доставки
1. **Курьер** - доставка по адресу с примеркой
2. **СДЭК** - доставка через СДЭК
3. **Самовывоз** - бесплатно из шоурума

### Система скидок
- **20% скидка** на доставку при заказе от 5000₽
- **Бесплатная доставка** при заказе от 10000₽

### Динамические цены
Цены доставки зависят от:
- Выбранного города
- Суммы заказа
- Веса товаров
- Расстояния доставки

## Использование

### Для пользователей
1. Выберите город доставки
2. Система автоматически загрузит доступные варианты доставки
3. Выберите подходящий метод доставки
4. При необходимости заполните адрес доставки

### Для разработчиков
1. **Добавление нового города**: отредактируйте массив `$deliverySettings` в `get_delivery_options.php`
2. **Изменение цен**: обновите значения в настройках города
3. **Новые методы доставки**: добавьте в массив и обновите HTML шаблон

## Настройка

### Добавление нового города
```php
'Новый город' => [
    'courier' => [
        'name' => 'Курьер по Новому городу',
        'description' => 'Описание доставки',
        'price' => 600,
        'min_order' => 0,
        'max_weight' => 30,
        'delivery_time' => '2-3 дня'
    ],
    // ... другие методы
]
```

### Изменение цен
```php
'Москва' => [
    'courier' => [
        'price' => 400, // Новая цена
        // ... остальные параметры
    ]
]
```

## Тестирование

1. Откройте `/test_delivery.html` в браузере
2. Выберите город
3. Установите сумму заказа
4. Проверьте загрузку вариантов доставки
5. Выберите метод доставки для проверки функциональности

## Требования

- PHP 7.4+
- Bitrix Framework
- jQuery 3.0+
- Модули: iblock, catalog, sale

## Безопасность

- Все входные данные валидируются
- SQL-инъекции предотвращены через Bitrix API
- XSS-атаки предотвращены через `htmlspecialchars()`
- Проверка авторизации пользователя

## Производительность

- Кэширование вариантов доставки
- Минимальные AJAX-запросы
- Оптимизированные SQL-запросы
- Асинхронная загрузка данных

## Поддержка

При возникновении проблем:
1. Проверьте консоль браузера на ошибки JavaScript
2. Проверьте логи PHP на сервере
3. Убедитесь, что все модули Bitrix подключены
4. Проверьте права доступа к файлам

## Обновления

### Версия 1.0
- Базовая функциональность динамической доставки
- Поддержка 4 основных городов
- Система скидок
- Адаптивный дизайн

### Планы развития
- Интеграция с API СДЭК для реальных цен
- Геолокация пользователя
- Расчет времени доставки
- Интеграция с картами
