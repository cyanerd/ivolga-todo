# Правки new.ivolga.moscow (04.12.2025)

## 1. Медленная загрузка каталога

**Статус:** Готово

**Приоритет:** Критический

**Страница:** /catalog/

**Заказчик:** Критически важно. Сейчас даже тестировать сложно. Предложено: кеширование, CDN, прокачать сервер.

Первичная загрузка каталога очень медленная. Фотографии прогружаются все сразу и наслаиваются друг на друга. Нужно разобраться с причинами помимо веса фотографий: проверить lazy loading, количество загружаемых элементов, ресайз изображений на сервере, пагинацию/подгрузку.

**Решение:**
- В шаблоне каталога (`catalog.section/catalog-page/template.php`) у слайдов 2+ заменён `src` на `data-src` — браузер не загружает скрытые фото при первой отрисовке
- В CSS (`app.css`) добавлено правило `img[data-src] { display: none }` — скрытые слайды не рендерятся до загрузки
- В JS (`productCard.js`) переписан слайдер: при наведении на карточку подгружаются скрытые фото, через 5 сек после загрузки страницы все оставшиеся фото подгружаются фоном. После загрузки `data-src` удаляется → CSS-правило перестаёт действовать → картинка появляется
- Также на сервер загружены оптимизированные изображения (iblock)
- Итого: первая загрузка — 20 картинок вместо 60, трафик при отрисовке уменьшен в ~3 раза

---

## 2. Разные фото в каталоге и в избранном

**Статус:** Готово

**Приоритет:** Средний

**Страница:** /catalog/, /favourite/

**Заказчик:** ОК

Миниатюры товаров в каталоге и в избранном отличаются — используются разные изображения (PREVIEW_PICTURE vs DETAIL_PICTURE или разные ресайзы). Нужно унифицировать источник фото. Также подготовить инструкцию по заполнению карточек товара, чтобы контент-менеджер загружал изображения корректно.

---

## 3. Баги в избранном

**Статус:** Готово

**Приоритет:** Средний

**Страница:** /favourite/

**Заказчик:** ОК

**3а.** При снятии сердечка с первых карточек в избранном — карточки исчезают, оставляя пустое место (не перестраивается сетка). Нужно после удаления из избранного перестраивать layout или перезагружать список.

**3б.** В избранном не переключаются фото при наведении курсора, хотя в других разделах (например, «Образы») переключение работает. Нужно подключить тот же hover-обработчик для карточек в избранном.

---

## 4. Раздел «Прямые эфиры» не подгружается

**Статус:** Неактуально (сейчас работает)

**Приоритет:** Высокий

**Страница:** /live/

**Заказчик:** ОК

Страница прямых эфиров пуста — отображается только хедер и футер, контент не загружается. Проверить компонент, данные инфоблока, наличие активных элементов.

---

## 5. Мультивыбор категорий в фильтре

**Статус:** Готово (под фича-флагом)

**Приоритет:** Средний

**Страница:** /catalog/ (фильтры)

**Заказчик:** Не скорректирован

Сейчас в фильтре категорий можно выбрать только одну категорию (radio). Нужно переделать на множественный выбор (checkbox), чтобы можно было фильтровать по нескольким категориям одновременно.

**Решение:** Реализовано под фича-флагом `MULTI_CATEGORY_FILTER` (`catalog/index.php`, строка 5). При `true` — чекбоксы, при `false` — радио (как было).
- **Шаблон** (`catalog-page/template.php`): рендерит `checkbox` + класс `checks` вместо `radio` + `radios` по флагу
- **JS** (`custom.js`): при мультивыборе категории собираются в GET-параметр `?categories=code1,code2` вместо URL-пути `/catalog/code/`
- **Бэкенд** (`catalog/index.php`): парсит `$_GET['categories']`, находит ID секций, фильтрует через `arrFilter['SECTION_ID']`. Компоненту передаётся `SHOW_ALL_WO_SECTION=Y`
- Флаг передаётся в JS через `window.MULTI_CATEGORY_FILTER`

---

## 6. Сердечки избранного не отображаются после фильтрации

**Статус:** Готово

**Приоритет:** Средний

**Страница:** /catalog/ (с фильтрами)

**Заказчик:** ОК

При использовании фильтров товары, добавленные в избранное, не помечаются черным сердечком. Без фильтров — отображается корректно. Вероятно, после AJAX-подгрузки отфильтрованных товаров не вызывается функция проверки/пометки избранных.

---

## 7. Сбой отображения строки сортировки при фильтрации

**Статус:** Готово

**Приоритет:** Низкий

**Страница:** /catalog/ (с фильтрами)

**Заказчик:** ОК

При использовании фильтров слетает отображение строки «Сортировать: по умолчанию» — визуально ломается верстка по сравнению со страницей без фильтров.

---

## 8. Пояснение по назначению цветов в фильтре

**Статус:** Закрыто (разъяснено)

**Приоритет:** Низкий (документация)

**Заказчик:** —

Цвета берутся из свойства TSVET товаров в инфоблоке каталога. Превьюшки хранятся в Highload-блоке ID=2 (поля UF_NAME — название, UF_COLOR_FILE — файл картинки). Сопоставление по названию цвета (в нижнем регистре). «Дубли» белых — это разные цвета, для которых не нашлось сопоставление в справочнике цветов. Управление: https://new.ivolga.moscow/bitrix/admin/highloadblock_rows_list.php?ENTITY_ID=2&lang=ru

---

## 9. Артефакты у квадратика цвета в каталоге

**Статус:** Готово

**Приоритет:** Низкий

**Страница:** /catalog/bazovye/

**Заказчик:** ОК, но просят пояснение — раньше цвет был «синий», сейчас указан как «мультиколор». Как скорректировали?

На странице каталога квадратик с голубым цветом отображается с цветными краями (артефакт), в то время как на карточке товара он выглядит корректно. Нужно поправить CSS/отображение кружка/квадратика цвета в листинге каталога по аналогии с карточкой товара.

---

## 10. Размеры некликабельные в карточке каталога

**Статус:** Частично

**Приоритет:** Средний

**Страница:** /catalog/ (карточки товаров)

**Заказчик:** Размеры стали кликабельными, но при проваливании в карточку выбранный размер НЕ активирован. Цвет при клике из каталога — активируется сразу, размер — нет. Нужно поправить, чтобы размер тоже был выбран.

В карточке товара в каталоге поля с цветами кликабельные (переход на карточку товара), а поля с размерами — нет. Пользователю непонятно различие в поведении. Нужно унифицировать: либо оба кликабельны (ведут на карточку), либо оба просто информационные.

---

## 11. Как назначить коллекцию вне артикула

**Статус:** Открыт (нужно уточнение)

**Приоритет:** Низкий (документация)

**Заказчик:** Понятно, что группы товаров приходят из 1С. Вопрос: как создать вкладку (Новый год, Распродажа), НЕ связанную с группой товаров из 1С? Нужна ли для этого 1С? Может ли один товар быть в нескольких вкладках?

Коллекции приходят из 1С. Управление через инфоблок каталога: https://new.ivolga.moscow/bitrix/admin/iblock_edit.php?type=CRM_PRODUCT_CATALOG&lang=ru&ID=34&admin=Y

---

## 12. Техническое название дублируется в карточке товара

**Статус:** Готово (частично)

**Приоритет:** Средний

**Страница:** /product/*

**Заказчик:** Пропало описание товара! Просили убрать только рабочее название, а описание должно остаться.

В карточке товара выводится техническое название (например, «Водолазка бордовая_FWBS020008/11»), которое содержит артикул. При этом артикул отдельно выводится ниже — получается дубль. Нужно убрать техническое название (рабочее), оставить только серый артикул и описание.

**Решение:** Вывод краткого описания (PREVIEW_TEXT) возвращён в шаблон. Проблема в том, что в PREVIEW_TEXT из 1С приходит техническое название — его нужно чистить либо в 1С, либо массово в Битрикс. Пока убран вручную у одного товара (ID 2376). Для остальных товаров нужно либо массово почистить PREVIEW_TEXT, либо убрать оттуда техназвание на стороне 1С.

---

## 13. Плавающий баг: цвета меняются местами

**Статус:** Не исправлено

**Приоритет:** Средний

**Страница:** /product/*

**Заказчик:** Не поправлено, баг сохраняется.

При первом открытии карточки товара и выборе цвета — квадраты с цветами меняются местами. При повторном выборе — перестают. Воспроизводится только при первом посещении карточки. Нужны точные шаги для воспроизведения — не удалось повторить.

---

## 14. Страница оформления заказа не загружается / ложится

**Статус:** Готово (ожидает проверки)

**Приоритет:** Критический

**Страница:** /checkout/

**Заказчик:** Пока не смогли проверить.

При переходе к оформлению заказа из превью корзины страница не загружается (белый экран). Иногда подгружается через 40-50 секунд, иногда нет. В DevTools летят 404-ошибки. Chrome 142, MacBook Air M1, macOS Monterey.

---

## 15. Проблемы с суммами в корзине заказа

**Статус:** Готово (15а-в), 15г — поведение Битрикс

**Приоритет:** Критический

**Страница:** /checkout/ (блок «Ваш заказ»)

**Заказчик:** Калькуляция корзины — см. комментарии выше (из текущей сессии).

**15а.** ~~Отображаются две суммы товаров (основная + мелким шрифтом «цена без скидки»). Вторую сумму убрать.~~ Готово (удален блок showPriceWithoutDiscount в editTotalBlock)

**15б.** ~~Дробные цены (49 455.99 ₽, 44.01 ₽, 50 015.99 ₽) — округлять до целых.~~ Готово (добавлена stripDecimals функция)

**15в.** ~~Не указано количество товаров — должно быть «X товаров на сумму:».~~ Готово (подсчет из GRID.ROWS + русские формы склонения)

**15г.** При применении купона корректируется первая сумма (сумма товаров), что противоречит логике. Купон должен уменьшать скидку/промокод, а не первую сумму. — Поведение Битрикс, ORDER_PRICE уже приходит с учетом купона.

**Корректный порядок строк:**
1. **X товаров на сумму:** сумма товаров без скидки и доставки, без мелкого шрифта
2. **Баллами:** (если введены) со знаком минус
3. **Промокод:** (если применен) со знаком минус
4. **Скидка:** со знаком минус (остальная скидка по программе лояльности)
5. **Доставка:** сумма доставки
6. **Итого:** сумма с учетом всех скидок. Только здесь можно мелко зачеркнутую сумму без скидки
7. **Вернется баллами:** (только для авторизованных)

---

## 16. Тексты полей на странице оформления

**Статус:** Готово

**Приоритет:** Низкий

**Страница:** /checkout/

**Заказчик:** ОК

- Поле ввода города: заменить «Введите название...» на «Введите город»
- Блок доставки: заменить «Для отображения опций доставки выберите город» на «Для отображения опций доставки введите город»

---

## 17. Обязательные поля при оформлении заказа

**Статус:** Требует доработки

**Приоритет:** Высокий

**Страница:** /checkout/

**Заказчик:** Не прозрачно. При пустом адресе просто не дает оформить заказ без оповещения. Через несколько кликов вылезло красное «The operation Website.CreateAuthorizedOrder failed». Нужно нормальное сообщение об обязательных полях.

Для курьера: Улица, Дом, Квартира (добавлено). Для СДЭК: выбор ПВЗ (добавлено). Для Почты России: выбор ПВЗ (добавлено). Общие поля (уже были): Имя, Фамилия, Email, Телефон. Комментарий к заказу — необязательный (как требовалось).

---

## 18. Сброс корзины и избранного через 1.5 часа

**Статус:** Частично (ожидает проверки)

**Приоритет:** Высокий

**Заказчик:** Пока не удалось протестировать.

У авторизованного пользователя через ~90 минут бездействия сбрасываются избранное и корзина. Время жизни сессии PHP увеличено, но хостер может переопределять значение — требуется проверка.

---

## 19. Авторизация не работает / зацикливается

**Статус:** Баг сохраняется (у заказчика)

**Приоритет:** Критический

**Заказчик:** Баг сохраняется, проблема с авторизацией остается.

После успешной авторизации (ввода SMS-кода) система снова просит авторизоваться. После трех успешно введенных SMS-кодов пользователь так и не вошел в ЛК. У нас не воспроизводится — нужно уточнить браузер/устройство заказчика.

---

## 20. Руководство по размерам — нет кнопки «Назад»

**Статус:** Закрыто

**Приоритет:** Низкий

**Страница:** /product/* (гид по размерам)

**Заказчик:** ОК, крестик добавлен.

В руководстве по размерам сверху есть крестик для закрытия модалки и возврата к карточке товара.

---

## 21. Тестирование программы лояльности заблокировано

**Статус:** Заблокировано (зависит от п.19)

**Приоритет:** Высокий

Невозможно протестировать программу лояльности, пока у заказчика не работает авторизация (п.19).

---

## 22. Два справочника цветов — разобраться и унифицировать

**Статус:** Открыт

**Приоритет:** Средний

**Страница:** Админка (Highload-блоки)

**Заказчик:** Вопрос от заказчика — какой справочник используется и можно ли убрать лишний?

В админке два Highload-блока по цветам:
- **TSVET** — содержит UF_NAME, UF_XML_ID, UF_LINK, UF_DESCRIPTION, UF_FULL_DESC. Нет миниатюр цветов.
- **Цвета** — содержит UF_NAME, UF_COLOR_FILE (миниатюра цвета). Есть картинки.

Номера (ID) и перечень цветов в них расходятся. Нужно выяснить:
1. На какой справочник ориентируется карточка товара при выводе цветных квадратиков?
2. Откуда подгружается миниатюра цвета?
3. Можно ли убрать лишний справочник и оставить один?

---

## 23. Прелоадер на страницу каталога

**Статус:** Открыт

**Приоритет:** Средний

**Страница:** /catalog/

**Заказчик:** Просит добавить простой прелоадер (~5 сек), чтобы фото успевали загрузиться до отображения контента. Пример: http://kingwood.su. Если за него нужно доплатить — просчитать.

Добавить анимированный прелоадер (лого или спиннер) на страницу каталога. Показывается при первой загрузке, скрывается когда основные изображения загружены (или по таймауту). Нужно согласовать дизайн с заказчиком.

---

## Сводка

| # | Задача | Наш статус | Заказчик |
|---|--------|------------|----------|
| 1 | Медленная загрузка каталога | Готово (24.02, lazy-load слайдов + оптимизация картинок) | КРИТ, нужно срочно |
| 2 | Разные фото каталог/избранное | Готово | ОК |
| 3 | Баги в избранном | Готово | ОК |
| 4 | Прямые эфиры | Неактуально | ОК |
| 5 | Мультивыбор категорий | Готово (24.02) | Не скорректирован |
| 6 | Сердечки после фильтрации | Готово | ОК |
| 7 | Строка сортировки | Готово | ОК |
| 8 | Пояснение по цветам | Закрыто | — |
| 9 | Артефакт цвета в каталоге | Готово | ОК, просят пояснение |
| 10 | Размеры некликабельные | **Частично** | Размер не выбирается при переходе |
| 11 | Коллекции вне артикула | **Нужно уточнение** | Как создать вкладку вне 1С? |
| 12 | Дубль тех. названия | Готово (24.02) | Пропало описание товара! |
| 13 | Цвета меняются местами | **Не исправлено** | Баг сохраняется |
| 14 | Checkout не грузится | Готово | Ожидает проверки |
| 15 | Суммы в корзине | Готово (15а-в), 15г — Битрикс | Калькуляция требует доработки |
| 16 | Тексты полей checkout | Готово | ОК |
| 17 | Обязательные поля | **Требует доработки** | Нет сообщения об ошибке, Mindbox ошибка |
| 18 | Сброс сессии | Частично | Не протестировано |
| 19 | Авторизация зациклена | **Не воспр. у нас** | Баг сохраняется у заказчика |
| 20 | Кнопка «Назад» в размерах | Закрыто | ОК |
| 21 | Тест лояльности | Заблокировано | Зависит от п.19 |
| 22 | Два справочника цветов | Открыт | Какой справочник используется? |
| 23 | Прелоадер каталога | Открыт | Пример: kingwood.su, просчитать доп. оплату |

---

## Дооценки (доп. часы)

| # | Задача | Часы | Комментарий |
|---|--------|------|-------------|
| 1 | Медленная загрузка каталога | 3ч | Анализ, lazy-load слайдов, оптимизация картинок, переписан productCard.js |
| 5 | Мультивыбор категорий в фильтре | 4ч | Доработка: radio → checkbox, фича-флаг, бэкенд фильтрация по нескольким секциям |
| 23 | Прелоадер каталога | 4ч | Анимированный прелоадер, согласование дизайна, интеграция |
